// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?
  name      String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Subscription info
  subscriptionTier String @default("basic") // basic, pro, elite
  subscriptionExpiry DateTime?
  
  // Trial and referral system
  trialExpiry DateTime?
  totalTrialDays Int @default(30)
  referredBy String? // User ID who referred this user
  
  // Profile data
  profile   UserProfile?
  accounts  Account[]
  positions Position[]
  strategies Strategy[]
  portfolioSnapshots PortfolioSnapshot[]
  riskAlerts RiskAlert[]
  taxRecords TaxRecord[]
  washSales WashSale[]
  learningProgress LearningProgress[]
  communityProfile CommunityProfile?
  tradingRules TradingRule[]
  smartNotifications SmartNotification[]
  brokerConnections BrokerConnection[]
  
  // Referral relations
  referralCodes ReferralCode[]
  referrals Referral[]
  
  // Admin and feedback relations
  isAdmin Boolean @default(false)
  feedback Feedback[]
  adminFeedbackResponses Feedback[] @relation("AdminFeedback")
  adminActions AdminAction[] @relation("AdminActions")
  targetAdminActions AdminAction[] @relation("AdminTargetActions")
  userNotes UserNote[] @relation("UserNotes")
  adminUserNotes UserNote[] @relation("AdminUserNotes")

  @@map("users")
}

model UserProfile {
  id              String @id @default(cuid())
  userId          String @unique
  user            User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Risk assessment
  riskTolerance   String // conservative, moderate, aggressive
  experienceLevel String // beginner, intermediate, advanced
  tradingGoals    String[] // income, speculation, hedging
  
  // Preferences
  dashboardLayout Json?
  notificationSettings Json?
  tradingHours    Json? // preferred trading times
  
  // KYC data
  dateOfBirth     DateTime?
  phoneNumber     String?
  address         Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("user_profiles")
}

// Brokerage Integration
model Account {
  id            String @id @default(cuid())
  userId        String
  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  broker        String // "interactive_brokers", "schwab", "tastytrade"
  accountNumber String
  accountType   String // "margin", "cash", "ira"
  isActive      Boolean @default(true)
  
  // Balances
  cashBalance   Decimal @default(0)
  buyingPower   Decimal @default(0)
  totalValue    Decimal @default(0)
  
  // API credentials (encrypted)
  apiCredentials Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  positions     Position[]

  @@unique([userId, accountNumber, broker])
  @@map("accounts")
}

// Trading Data
model Position {
  id          String @id @default(cuid())
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId   String
  account     Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // Position details
  symbol      String
  strategyType String // "covered_call", "put_spread", "iron_condor", etc.
  quantity    Int
  entryDate   DateTime
  exitDate    DateTime?
  
  // Financial data
  entryPrice  Decimal
  exitPrice   Decimal?
  unrealizedPnl Decimal?
  realizedPnl   Decimal?
  
  // Risk metrics
  delta       Decimal?
  gamma       Decimal?
  theta       Decimal?
  vega        Decimal?
  
  // Position legs (for complex strategies)
  legs        PositionLeg[]
  
  // AI analysis
  aiScore     Decimal? // AI confidence score
  aiNotes     String?
  
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  transactions Transaction[]

  @@map("positions")
}

model PositionLeg {
  id         String @id @default(cuid())
  positionId String
  position   Position @relation(fields: [positionId], references: [id], onDelete: Cascade)
  
  // Option details
  symbol     String
  optionType String // "call", "put"
  strike     Decimal
  expiry     DateTime
  quantity   Int
  side       String // "buy", "sell"
  
  // Pricing
  entryPrice Decimal
  exitPrice  Decimal?
  
  // Greeks at entry
  delta      Decimal?
  gamma      Decimal?
  theta      Decimal?
  vega       Decimal?
  iv         Decimal? // implied volatility
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("position_legs")
}

model Transaction {
  id         String @id @default(cuid())
  positionId String
  position   Position @relation(fields: [positionId], references: [id], onDelete: Cascade)
  
  type       String // "buy", "sell", "exercise", "assignment"
  symbol     String
  quantity   Int
  price      Decimal
  fees       Decimal @default(0)
  timestamp  DateTime
  
  // Tax implications
  washSale   Boolean @default(false)
  
  createdAt  DateTime @default(now())

  @@map("transactions")
}

// Strategy System
model Strategy {
  id          String @id @default(cuid())
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  strategyType String
  parameters  Json // strategy-specific parameters
  
  // Backtesting results
  backtestData Json?
  successRate  Decimal?
  avgReturn    Decimal?
  maxDrawdown  Decimal?
  sharpeRatio  Decimal?
  
  // AI analysis
  aiScore     Decimal?
  
  isPublic    Boolean @default(false)
  isActive    Boolean @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("strategies")
}

// Risk Management
model PortfolioSnapshot {
  id         String @id @default(cuid())
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  timestamp  DateTime
  totalValue Decimal
  
  // Risk metrics
  totalDelta Decimal
  totalGamma Decimal
  totalTheta Decimal
  totalVega  Decimal
  
  // Stress test results
  stressTests Json
  
  // VaR calculations
  var95      Decimal? // 95% Value at Risk
  var99      Decimal? // 99% Value at Risk
  
  createdAt  DateTime @default(now())

  @@map("portfolio_snapshots")
}

model RiskAlert {
  id         String @id @default(cuid())
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  alertType  String // "position_risk", "portfolio_risk", "market_event"
  severity   String // "low", "medium", "high", "critical"
  message    String
  data       Json? // alert-specific data
  
  isRead     Boolean @default(false)
  isResolved Boolean @default(false)
  
  createdAt  DateTime @default(now())

  @@map("risk_alerts")
}

// Tax Optimization
model TaxRecord {
  id         String @id @default(cuid())
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  year       Int
  symbol     String
  quantity   Decimal
  costBasis  Decimal
  dateAcquired DateTime
  dateSold   DateTime?
  salePrice  Decimal?
  
  // Tax treatment
  isShortTerm Boolean?
  isWashSale Boolean @default(false)
  
  // Optimization opportunities
  harvestable Boolean @default(false)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("tax_records")
}

model WashSale {
  id             String @id @default(cuid())
  userId         String
  user           User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  symbol         String
  lossDate       DateTime
  lossAmount     Decimal
  washPeriodEnd  DateTime
  
  isActive       Boolean @default(true)
  
  createdAt      DateTime @default(now())

  @@map("wash_sales")
}

// Learning System
model LearningProgress {
  id         String @id @default(cuid())
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  moduleId   String
  moduleName String
  progress   Int @default(0) // 0-100
  completed  Boolean @default(false)
  score      Int?
  
  // Adaptive learning data
  weaknesses String[] // areas that need improvement
  strengths  String[] // areas of strength
  
  lastAccessed DateTime?
  completedAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, moduleId])
  @@map("learning_progress")
}

// Community Features
model CommunityProfile {
  id         String @id @default(cuid())
  userId     String @unique
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  username   String @unique
  bio        String?
  
  // Performance metrics (anonymized)
  successRate    Decimal?
  avgReturn      Decimal?
  riskAdjReturn  Decimal?
  totalTrades    Int @default(0)
  
  // Community metrics
  reputation     Int @default(0)
  contributions  Int @default(0)
  
  // Privacy settings
  sharePerformance Boolean @default(false)
  shareStrategies  Boolean @default(false)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("community_profiles")
}

// Market Data Cache
model OptionChain {
  id         String @id @default(cuid())
  symbol     String
  expiry     DateTime
  strike     Decimal
  optionType String // "call", "put"
  
  // Pricing data
  bid        Decimal?
  ask        Decimal?
  lastPrice  Decimal?
  volume     Int?
  openInterest Int?
  
  // Greeks
  delta      Decimal?
  gamma      Decimal?
  theta      Decimal?
  vega       Decimal?
  rho        Decimal?
  
  // Other metrics
  impliedVolatility Decimal?
  
  timestamp  DateTime
  createdAt  DateTime @default(now())

  @@unique([symbol, expiry, strike, optionType])
  @@map("option_chains")
}

model MarketData {
  id         String @id @default(cuid())
  symbol     String
  
  // Price data
  price      Decimal
  change     Decimal
  changePercent Decimal
  volume     BigInt?
  
  // Additional metrics
  beta       Decimal?
  marketCap  BigInt?
  
  timestamp  DateTime
  createdAt  DateTime @default(now())

  @@unique([symbol, timestamp])
  @@map("market_data")
}

// ─── TRADING RULES & SAFETY ──────────────────────────────────────────────────

model TradingRule {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name                String
  ruleType            String   // "position_size", "timing", "frequency", "symbol", "strategy"
  condition           Json     // Flexible rule conditions
  action              String   // "block", "warn", "require_reason"
  isActive            Boolean  @default(true)
  
  priority            Int      @default(0)
  
  violations          RuleViolation[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([userId, isActive])
}

model RuleViolation {
  id                  String      @id @default(cuid())
  ruleId              String
  rule                TradingRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  userId              String
  
  positionId          String?
  tradeId             String?
  
  violationType       String      // "override", "blocked", "warning_ignored"
  overrideReason      String?
  overridePassword    Boolean     @default(false)
  
  cost                Float?      // If violation led to loss, track it
  
  timestamp           DateTime    @default(now())
  
  @@index([ruleId])
  @@index([userId, timestamp])
}

model SmartNotification {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type                String   // "position_action", "rule_violation", "trade_idea", etc.
  priority            String   // "urgent", "high", "normal", "low"
  category            String   // "action_required", "informational", "educational"
  
  title               String
  body                String
  explanation         String   // WHY this notification matters
  actionRequired      Boolean  @default(false)
  
  contextData         Json     // Position ID, rule ID, etc.
  
  actionButtons       Json?    // [{label: "Close Position", action: "close", data: {...}}]
  
  read                Boolean  @default(false)
  dismissed           Boolean  @default(false)
  actioned            Boolean  @default(false)
  
  scheduledFor        DateTime?
  deliveredAt         DateTime?
  
  channels            String[] // ["push", "email", "sms"]
  
  createdAt           DateTime @default(now())
  
  @@index([userId, read, priority])
  @@index([scheduledFor])
}

model BrokerConnection {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  broker              String   // "tastytrade", "ibkr", "schwab", "etrade"
  accountId           String
  
  accessToken         String   // Encrypted
  refreshToken        String?  // Encrypted
  
  status              String   @default("connected") // "connected", "disconnected", "error"
  lastSync            DateTime?
  
  paperAccount        Boolean  @default(false)
  
  syncPositions       Boolean  @default(true)
  enableOneClick      Boolean  @default(false)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([userId, broker, accountId])
  @@index([userId])
}

// ─── REFERRAL SYSTEM ──────────────────────────────────────────────────────────

model ReferralCode {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  code                String   @unique
  isActive            Boolean  @default(true)
  
  successfulReferrals Referral[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([userId])
  @@index([code])
}

model Referral {
  id                  String      @id @default(cuid())
  referrerCodeId      String
  referralCode        ReferralCode @relation(fields: [referrerCodeId], references: [id], onDelete: Cascade)
  
  referredUserId      String
  referredUser        User        @relation(fields: [referredUserId], references: [id], onDelete: Cascade)
  
  status              String      @default("pending") // "pending", "completed", "failed"
  rewardType          String?     // "trial_extension", "discount", "credit"
  rewardValue         Int?        // Number of days, percentage, or amount
  
  rewardDelivered     Boolean     @default(false)
  rewardDeliveredAt   DateTime?
  
  createdAt           DateTime    @default(now())
  
  @@index([referrerCodeId])
  @@index([referredUserId])
  @@index([status])
}

// ─── FEEDBACK & ADMIN SYSTEM ──────────────────────────────────────────────────

model Feedback {
  id                  String   @id @default(cuid())
  userId              String?
  user                User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Contact info for anonymous feedback
  email               String?
  name                String?
  
  category            String   // "bug", "feature", "improvement", "complaint", "praise"
  subject             String
  message             String   @db.Text
  priority            String   @default("medium") // "low", "medium", "high", "critical"
  
  // Admin response
  status              String   @default("open") // "open", "in_progress", "resolved", "closed"
  adminResponse       String?  @db.Text
  adminId             String?
  admin               User?    @relation("AdminFeedback", fields: [adminId], references: [id])
  respondedAt         DateTime?
  
  // Metadata
  userAgent           String?
  url                 String?
  screenshot          String?  // URL to uploaded screenshot
  systemInfo          Json?    // Browser, OS, etc.
  
  // Satisfaction tracking
  satisfactionRating  Int?     // 1-5 rating after resolution
  satisfactionComment String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
}

model AdminAction {
  id                  String   @id @default(cuid())
  adminId             String
  admin               User     @relation("AdminActions", fields: [adminId], references: [id])
  
  action              String   // "user_created", "user_updated", "user_deleted", "refund_issued", "feedback_responded"
  targetUserId        String?
  targetUser          User?    @relation("AdminTargetActions", fields: [targetUserId], references: [id])
  
  details             Json?    // Additional action details
  reason              String?  // Reason for action
  
  // Refund specific
  refundAmount        Decimal?
  refundReason        String?
  refundMethod        String?  // "stripe", "manual", etc.
  refundId            String?  // External refund ID
  
  createdAt           DateTime @default(now())
  
  @@index([adminId])
  @@index([targetUserId])
  @@index([action])
  @@index([createdAt])
}

model UserNote {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation("UserNotes", fields: [userId], references: [id], onDelete: Cascade)
  adminId             String
  admin               User     @relation("AdminUserNotes", fields: [adminId], references: [id])
  
  note                String   @db.Text
  isPrivate           Boolean  @default(true) // Only visible to admins
  category            String?  // "general", "billing", "support", "warning"
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([userId])
  @@index([adminId])
}